define("editor/directive",["require","jquery","angular"],function(e){var t=e("jquery"),n=e("angular");return function(e){e.directive("insertHtml",["$parse",function(e){return function(t,r,i){var s=e(i.insertHtml)(t);n.isArray(s)?s.length?r.html(s.join("")):r.html(i.insertHtml.replace(/^[^|]+\|\|(?=[^|]+$)/,"").replace(/^['"\s]+|['"\s]+$/g,"")):n.isString(s)&&r.html(s)}}]),e.directive("dragSetComponents",["$compile","componentTransclude",function(e,t){return{scope:{tree:"="},restrict:"A",link:function(e,n,r){t.set(n)}}}]),e.directive("component",["$compile",function(e){return{restrict:"A",link:function(t,n,r){var i=(r.component||"").replace(/([A-Z])/g,"-$1");if(!i)return;var s=e("<"+i+"></"+i+">")(t);n.append(s)}}}]),e.directive("saveContent",["contentAnalysis",function(e){return{scope:!0,restrict:"A",link:function(t,n,r){n.on("keyup keydown paste",function(e){if(e.keyCode===13)return!1;t.$apply(r.saveContent),e.stopPropagation()}),t.save=function(t,r){t[r]=e.run(n[0])}}}}]),e.directive("cmsEditable",["rangeTransferStation",function(e){return{restrict:"A",link:function(t,n,r){n.on("keyup mouseup",function(){e.set(n[0])})}}}]),e.directive("saveTree",function(){return function(e,r,i){r.on("click",function(){function o(e,t){var n=e.children;for(var r=0,i=n.length;r<i;r++)if(n[r].content){var s=n[r].content;n[r].content.tree&&(s.tree=[]),t.push(s),o(n[r],s.tree||s.component)}else o(n[r],t)}function u(e){if(n.isArray(e))return!!e.length;if(n.isObject(e)){delete e.$$hashKey;for(var t in e)return!1;return!0}}function a(e,t){if(n.isArray(e)){var r=[];for(var i=0,s=e.length;i<s;i++){var o=a(e[i],t);o&&r.push(o)}return r.length?r:!1}if(n.isObject(e)){var f={};delete e.$$hashKey;for(var l in e){var o=a(e[l],e.componentName||t);o&&(f[l]=o)}return!u(f)||t=="tableResponsive"?f:!1}return e}var r=t(i.saveTree)[0],s=[];o(r,s),e.tree=a(n.copy(s)),e.$apply(i.save)})}}),e.directive("selection",function(){return{restrict:"A",link:function(e,t,n){t.on("selectstrat",function(e){alert("aaa")})}}}),e.directive("ngUpload",function(){return{scope:{imgSrc:"=imgSrc"},restrict:"A",link:function(e,n,r){var i="id"+(new Date).getTime();n.prop("id",i);var s=t("#"+i);e.imgSrc=e.imgSrc||"../../resources/images/components/picture/img-empty.png",s.on("change",function(){var n=t(this).attr("data-fileType");e.imgSrc="../../resources/images/test.jpg",e.$apply();return;var r})}}})}}),define("editor/components/gridComponents/rootComponent/rootComponent",["require"],function(e){return function(t){t.directive("rootComponent",["$compile",function(t){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./rootComponent.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.content}]}}])}}),define("editor/components/gridComponents/blockComponent/blockComponent",["require"],function(e){return function(t){t.directive("blockComponent",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./blockComponent.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t){var n=t.parent()[0];n.content=e.content=e.content||{componentName:"blockComponent",tree:[{}]},e.add=function(t){e.content.tree.splice(t+1,0,{})},e.remove=function(t){e.content.tree.splice(t,1)}}}})}}),define("editor/components/gridComponents/grid444/grid444",["require"],function(e){return function(t){t.directive("grid444",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./grid444.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t){var n=t.parent()[0];n.content=e.content=e.content||{componentName:"grid444",tree:[{},{},{}]};if(e.content.componentName!="grid444")return;e.add=function(t){e.content.tree.splice(t+1,0,{})},e.remove=function(t){e.content.tree.splice(t,1)}}}})}}),define("editor/components/gridComponents/grid3333/grid3333",["require"],function(e){return function(t){t.directive("grid3333",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./grid3333.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t){var n=t.parent()[0];n.content=e.content=e.content||{componentName:"grid3333",tree:[{},{},{},{}]};if(e.content.componentName!="grid3333")return;e.add=function(t){e.content.tree.splice(t+1,0,{})},e.remove=function(t){e.content.tree.splice(t,1)}}}})}}),define("editor/components/articleComponents/titleAndBody/titleAndBody",["require"],function(e){return function(t){t.directive("titleAndBody",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./titleAndBody.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){var r=t.parent()[0];r.content=e.content=e.content||{componentName:"titleAndBody",component:[{title:[],smallTitle:[],children:[{text:[]}]}]},e.add=function(t){e.content.component.splice(t+1,0,{title:[],smallTitle:[],children:[{text:[]}]})},e.addChild=function(e,t){t.splice(e+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)},e.removeChild=function(t,n,r){n.splice(t,1),n.length||e.content.component.splice(r,1)}}}})}}),define("editor/components/articleComponents/paragraph/paragraph",["require"],function(e){return function(t){t.directive("paragraph",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./paragraph.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t){var n=t.parent()[0];n.content=e.content=e.content||{componentName:"paragraph",component:[{}]};if(e.content.componentName!="paragraph")return;e.add=function(t){e.content.component.splice(t+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)}}}})}}),define("editor/components/listComponents/listUl/listUl",["require"],function(e){return function(t){t.directive("listUl",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./listUl.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){var r=t.parent()[0];r.content=e.content=e.content||{componentName:"listUl",component:[{children:[{text:[]}]}]},e.add=function(t){e.content.component.splice(t+1,0,{children:[{text:[]}]})},e.addChild=function(e,t){t.splice(e+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)},e.removeChild=function(t,n,r){n.splice(t,1),n.length||e.content.component.splice(r,1)}}}})}}),define("editor/components/listComponents/listOl/listOl",["require"],function(e){return function(t){t.directive("listOl",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./listOl.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){var r=t.parent()[0];r.content=e.content=e.content||{componentName:"listOl",component:[{children:[{text:[]}]}]},e.add=function(t){e.content.component.splice(t+1,0,{children:[{text:[]}]})},e.addChild=function(e,t){t.splice(e+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)},e.removeChild=function(t,n,r){n.splice(t,1),n.length||e.content.component.splice(r,1)}}}})}}),define("editor/components/listComponents/listDl/listDl",["require"],function(e){return function(t){t.directive("listDl",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./listDl.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){var r=t.parent()[0];r.content=e.content=e.content||{componentName:"listDl",component:[{children:[{title:[],text:[]}]}]},e.add=function(t){e.content.component.splice(t+1,0,{children:[{title:[],text:[]}]})},e.addChild=function(e,t){t.splice(e+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)},e.removeChild=function(t,n,r){n.splice(t,1),n.length||e.content.component.splice(r,1)}}}})}}),define("editor/components/pictureComponents/pictureLeft/pictureLeft",["require"],function(e){return function(t){t.directive("pictureLeft",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./pictureLeft.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){var r=t.parent()[0];r.content=e.content=e.content||{componentName:"pictureLeft",component:[{imgSrc:"",children:[{text:[]}]}]},e.add=function(t){e.content.component.splice(t+1,0,{imgSrc:"",children:[{text:[]}]})},e.addChild=function(e,t){t.splice(e+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)},e.removeChild=function(t,n,r){n.splice(t,1),n.length||e.content.component.splice(r,1)}}}})}}),define("editor/components/pictureComponents/pictureRight/pictureRight",["require"],function(e){return function(t){t.directive("pictureRight",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./pictureRight.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){var r=t.parent()[0];r.content=e.content=e.content||{componentName:"pictureRight",component:[{imgSrc:"",children:[{text:[]}]}]},e.add=function(t){e.content.component.splice(t+1,0,{imgSrc:"",children:[{text:[]}]})},e.addChild=function(e,t){t.splice(e+1,0,{})},e.remove=function(t){e.content.component.splice(t,1)},e.removeChild=function(t,n,r){n.splice(t,1),n.length||e.content.component.splice(r,1)}}}})}}),define("editor/components/tableComponents/tableResponsive/tableResponsive",["require"],function(e){return function(t){t.directive("tableResponsive",function(){return{scope:!0,restrict:"E",templateUrl:e.toUrl("./tableResponsive.html"),replace:!0,controller:["$scope",function(e){e.content=e.$parent.item}],link:function(e,t,n){function i(e,t){var n={thead:[],tbody:[],tfoot:[]};for(var r=0;r<t;r++)n.thead.push({}),n.tfoot.push({});for(var r=0;r<e;r++){var i=[];for(var s=0;s<t;s++)i.push({});n.tbody.push(i)}return n}var r=t.parent()[0];r.content=e.content=e.content||{componentName:"tableResponsive",component:[i(2,3)]},e.addRow=function(e,t){e.tbody.splice(t+1,0,function(){var t=[];for(var n=0;n<e.thead.length;n++)t.push({});return t}())},e.addCol=function(e,t){e.thead.splice(t+1,0,{});for(var n=0;n<e.tbody.length;n++)e.tbody[n].splice(t+1,0,{});e.tfoot.splice(t+1,0,{})},e.removeRow=function(e,t){e.tbody.splice(t,1)},e.removeCol=function(e,t){e.thead.splice(t,1);for(var n=0;n<e.tbody.length;n++)e.tbody[n].splice(t,1);e.tfoot.splice(t,1)},e.add=function(t){e.content.component.splice(t+1,0,i(2,3))},e.remove=function(t){e.content.component.splice(t,1)}}}})}}),define("editor/controller",["require","angular"],function(e){var t=e("angular");return function(e){e.controller("editorControl",["$scope","$http","$location","baseUrl",function(e,t,n,r){var i=n.search().id;e.content={componentName:"rootComponent",tree:[{}]};if(i=="localSource"){var s=JSON.parse(localStorage.getItem("article"));e.content.tree=s.content,e.type=s.type,e.title=s.title,e.source=s.source}else i&&t({url:r.baseUrl+"system/content/filter/queryContentById_async",method:"get",params:{id:i}}).success(function(t){t.success&&(e.content.tree=t.data.contentObj,e.type=t.data.type,e.title=t.data.title,e.source=t.data.source)});e.save=function(){t({url:r.baseUrl+"system/content/filter/saveOrUpdateContent_async",method:"post",data:{content:e.tree,title:e.title,type:e.type,source:e.source,id:i},headers:{"Content-Type":"application/json;"}}).success(function(e){alert(e.msg)})},e.show=function(){localStorage.setItem("article",JSON.stringify({content:e.tree,title:e.title,type:e.type,source:e.source}))}}])}}),define("editor/service",["require","jquery"],function(e){var t=e("jquery");return function(e){e.service("componentTransclude",["$compile","$rootScope",function(e,n){function r(e,n){var r=t(e),i=t(n),s=r.offset().top,o=r.offset().left,u=o+r.width(),a=s+r.height(),f=i.offset().top,l=i.offset().left,c=l+i.width(),h=f+i.height();return f>a||c<o||h<s||l>u?!1:!0}var i=[];this.set=function(e){i.push(e)},t("#left-bar li").each(function(e,n){t(n).on("mousedown","img[component]",function(){t(n).addClass("active")}),t(n).on("mouseup","img[component]",function(){t(n).removeClass("active")})}),t(document).on("mousedown","img[component]",function(s){var o=t(s.target),u=s.clientX,a=s.clientY,f=o.position(),l=o.clone().insertBefore(o);return l.css({position:"absolute",width:o.width(),height:o.height(),left:f.left,top:f.top,zIndex:5}),t(document).on("mousemove.dragComponent",function(e){l.css({left:f.left+e.clientX-u,top:f.top+e.clientY-a});var t=e.target.getAttribute("component");for(var n=0;n<i.length;n++){if(i[n].children().length)continue;t&&e.target===e.toElement&&(r(e.target,i[n])?i[n].addClass("hover"):i[n].removeClass("hover"))}}),t(document).one("mouseup.dragComponent",function(s){var o=null,u=[];for(var a=0;a<i.length;a++)i[a].parent().length&&(u.push(i[a]),i[a].removeClass("hover"),r(s.target,i[a])&&(o=i[a]));i=u,l.remove(),t(document).off("mousemove.dragComponent");if(!o)return;if(o.children().length)return;var f=s.target.getAttribute("component");if(f){var c=e("<"+f+"></"+f+">")(n.$new());c.appendTo(o)}}),!1})}]),e.factory("contentAnalysis",function(){return{run:function(e){var t=[],n=e.childNodes;for(var r=0;r<n.length;r++)n[r].nodeType===1?t.push({tagName:n[r].tagName,innerText:n[r].innerText,className:n[r].className}):n[r].nodeType===3&&t.push(n[r].nodeValue);return t}}}),e.factory("baseUrl",function(){return{baseUrl:"/CMS/"}}),e.factory("httpResponsePermissionInterceptor",["$q","$location",function(e,t){return function(n){return n.then(function(e){return e},function(n){return n.status===403||n.status===401?(t.path("/home"),e.reject(n)):e.reject(n)})}}]),e.factory("logoutInterceptor",["$q",function(e){var t={request:function(e){return e},response:function(e){if(typeof e.data=="object"&&e.data.msg=="请登录"){location.href="./login";return}return e},requestError:function(t){return e.reject(t)},responseError:function(e){return e}};return t}]),e.service("rangeTransferStation",function(){var e=document.getSelection(),n=null;this.set=function(e){n=e},t("#editable-btns").on("click","button",function(){function a(e,t){if(!e)return;return e.contentEditable=="true"?!1:t.test(e.tagName)?!0:(e=e.parentNode,a(e,t))}function c(e,t,n){return n.test(e.tagName)?e.parentNode:(e=e.parentNode,c(e,t,n))}function m(e){if(!e)return;var t=e.children;for(var n=0;n<t.length;n++)t[n].innerText?m(t[n]):(e.removeChild(t[n]),n--)}if(!n)return;var r=t(this).attr("edit-type").replace(/^\s+|\s+$/g,""),i=e.getRangeAt(0),s=i.commonAncestorContainer,o=s;while(o){if(!o.parentNode)return;if(o.contentEditable=="true")break;o=o.parentNode}var u=s.parentNode,f=a(u,new RegExp("^"+r+"$","i")),l=u.getElementsByTagName(r).length;if(f){console.log("拆分父级");var h=c(u,r,new RegExp(r,"i")),p=document.createRange();p.setStart(h,0),p.setEnd(i.startContainer,i.startOffset);var d=document.createRange();d.selectNodeContents(h),d.setStart(i.endContainer,i.endOffset),h.appendChild(p.extractContents()),h.appendChild(i.extractContents()),h.appendChild(d.extractContents())}else{console.log("创建新元素");var v=document.createElement(r);v.appendChild(i.extractContents()),v.innerHTML=v.innerHTML.replace(new RegExp("</?"+r+">","img"),""),i.insertNode(v)}m(n),n.normalize(),n=null})})}}),define("editor",["require","angular","jquery","./editor/directive","./editor/components/gridComponents/rootComponent/rootComponent","./editor/components/gridComponents/blockComponent/blockComponent","./editor/components/gridComponents/grid444/grid444","./editor/components/gridComponents/grid3333/grid3333","./editor/components/articleComponents/titleAndBody/titleAndBody","./editor/components/articleComponents/paragraph/paragraph","./editor/components/listComponents/listUl/listUl","./editor/components/listComponents/listOl/listOl","./editor/components/listComponents/listDl/listDl","./editor/components/pictureComponents/pictureLeft/pictureLeft","./editor/components/pictureComponents/pictureRight/pictureRight","./editor/components/tableComponents/tableResponsive/tableResponsive","./editor/controller","./editor/service"],function(e){var t=e("angular"),n=e("jquery"),r=t.module("editor",[]);e("./editor/directive")(r),e("./editor/components/gridComponents/rootComponent/rootComponent")(r),e("./editor/components/gridComponents/blockComponent/blockComponent")(r),e("./editor/components/gridComponents/grid444/grid444")(r),e("./editor/components/gridComponents/grid3333/grid3333")(r),e("./editor/components/articleComponents/titleAndBody/titleAndBody")(r),e("./editor/components/articleComponents/paragraph/paragraph")(r),e("./editor/components/listComponents/listUl/listUl")(r),e("./editor/components/listComponents/listOl/listOl")(r),e("./editor/components/listComponents/listDl/listDl")(r),e("./editor/components/pictureComponents/pictureLeft/pictureLeft")(r),e("./editor/components/pictureComponents/pictureRight/pictureRight")(r),e("./editor/components/tableComponents/tableResponsive/tableResponsive")(r),e("./editor/controller")(r),e("./editor/service")(r),t.element(document).ready(function(){t.bootstrap(document,["editor"])})});
