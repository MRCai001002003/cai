define(["require","jquery"],function(e){var t=e("jquery");return function(e){e.service("componentTransclude",["$compile","$rootScope",function(e,n){function r(e,n){var r=t(e),i=t(n),s=r.offset().top,o=r.offset().left,u=o+r.width(),a=s+r.height(),f=i.offset().top,l=i.offset().left,c=l+i.width(),h=f+i.height();return f>a||c<o||h<s||l>u?!1:!0}var i=[];this.set=function(e){i.push(e)},t("#left-bar li").each(function(e,n){t(n).on("mousedown","img[component]",function(){t(n).addClass("active")}),t(n).on("mouseup","img[component]",function(){t(n).removeClass("active")})}),t(document).on("mousedown","img[component]",function(s){var o=t(s.target),u=s.clientX,a=s.clientY,f=o.position(),l=o.clone().insertBefore(o);return l.css({position:"absolute",width:o.width(),height:o.height(),left:f.left,top:f.top,zIndex:5}),t(document).on("mousemove.dragComponent",function(e){l.css({left:f.left+e.clientX-u,top:f.top+e.clientY-a});var t=e.target.getAttribute("component");for(var n=0;n<i.length;n++){if(i[n].children().length)continue;t&&e.target===e.toElement&&(r(e.target,i[n])?i[n].addClass("hover"):i[n].removeClass("hover"))}}),t(document).one("mouseup.dragComponent",function(s){var o=null,u=[];for(var a=0;a<i.length;a++)i[a].parent().length&&(u.push(i[a]),i[a].removeClass("hover"),r(s.target,i[a])&&(o=i[a]));i=u,l.remove(),t(document).off("mousemove.dragComponent");if(!o)return;if(o.children().length)return;var f=s.target.getAttribute("component");if(f){var c=e("<"+f+"></"+f+">")(n.$new());c.appendTo(o)}}),!1})}]),e.factory("contentAnalysis",function(){return{run:function(e){var t=[],n=e.childNodes;for(var r=0;r<n.length;r++)n[r].nodeType===1?t.push({tagName:n[r].tagName,innerText:n[r].innerText,className:n[r].className}):n[r].nodeType===3&&t.push(n[r].nodeValue);return t}}}),e.factory("baseUrl",function(){return{baseUrl:"/CMS/"}}),e.factory("httpResponsePermissionInterceptor",["$q","$location",function(e,t){return function(n){return n.then(function(e){return e},function(n){return n.status===403||n.status===401?(t.path("/home"),e.reject(n)):e.reject(n)})}}]),e.factory("logoutInterceptor",["$q",function(e){var t={request:function(e){return e},response:function(e){if(typeof e.data=="object"&&e.data.msg=="请登录"){location.href="./login";return}return e},requestError:function(t){return e.reject(t)},responseError:function(e){return e}};return t}]),e.service("rangeTransferStation",function(){var e=document.getSelection(),n=null;this.set=function(e){n=e},t("#editable-btns").on("click","button",function(){function a(e,t){if(!e)return;return e.contentEditable=="true"?!1:t.test(e.tagName)?!0:(e=e.parentNode,a(e,t))}function c(e,t,n){return n.test(e.tagName)?e.parentNode:(e=e.parentNode,c(e,t,n))}function m(e){if(!e)return;var t=e.children;for(var n=0;n<t.length;n++)t[n].innerText?m(t[n]):(e.removeChild(t[n]),n--)}if(!n)return;var r=t(this).attr("edit-type").replace(/^\s+|\s+$/g,""),i=e.getRangeAt(0),s=i.commonAncestorContainer,o=s;while(o){if(!o.parentNode)return;if(o.contentEditable=="true")break;o=o.parentNode}var u=s.parentNode,f=a(u,new RegExp("^"+r+"$","i")),l=u.getElementsByTagName(r).length;if(f){console.log("拆分父级");var h=c(u,r,new RegExp(r,"i")),p=document.createRange();p.setStart(h,0),p.setEnd(i.startContainer,i.startOffset);var d=document.createRange();d.selectNodeContents(h),d.setStart(i.endContainer,i.endOffset),h.appendChild(p.extractContents()),h.appendChild(i.extractContents()),h.appendChild(d.extractContents())}else{console.log("创建新元素");var v=document.createElement(r);v.appendChild(i.extractContents()),v.innerHTML=v.innerHTML.replace(new RegExp("</?"+r+">","img"),""),i.insertNode(v)}m(n),n.normalize(),n=null})})}});
